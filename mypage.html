<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
<style>
body{
  margin:0;
  font-family:sans-serif;
  background:#eef2ff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#4f7cff;
  color:white;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
main{
  max-width:700px;
  margin:30px auto;
  flex:1;
}
.card{
  background:white;
  padding:25px;
  border-radius:12px;
  margin-bottom:20px;
}
input{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  width:100%;
  margin-top:8px;
}
button{
  background:#4f7cff;
  color:white;
  border:none;
  border-radius:10px;
  padding:10px 16px;
  margin-top:10px;
  cursor:pointer;
}
.notice{color:red;}
.success{color:green;}
</style>
</head>
<body>

<header>
  <div>ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
  <button onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ </button>
</header>

<main>

<div class="card">
  <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
  <p>UID: <span id="uid"></span></p>
  <p>Email: <span id="email"></span></p>
  <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <span id="usernameText">æœªè¨­å®š</span></p>
  <p>ä½œæˆã—ãŸå˜èªå¸³æ•°: <span id="bookCount">0</span></p>
</div>

<div class="card">
  <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®šãƒ»å¤‰æ›´</h2>
  <input id="usernameInput" placeholder="æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
  <button onclick="updateUsername()">å¤‰æ›´ã™ã‚‹</button>
  <div id="nameMsg" class="notice"></div>
</div>

<div class="card">
  <h2>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
  <input type="password" id="currentPass" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <input type="password" id="newPass" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="changePassword()">å¤‰æ›´ã™ã‚‹</button>
  <div id="passMsg" class="notice"></div>
</div>

</main>

<footer style="background:#4f7cff;color:white;text-align:center;padding:15px;">
Â© 2026 Wordbook App
</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7CJmO3eAO0o2EPRDsVqTtZ_whRd_3-3E",
  authDomain: "quiz1-4ffdc.firebaseapp.com",
  projectId: "quiz1-4ffdc"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;

auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="login.html";
  }else{
    currentUser = user;
    document.getElementById("uid").textContent = user.uid;
    document.getElementById("email").textContent = user.email;
    document.getElementById("usernameText").textContent = user.displayName || "æœªè¨­å®š";

    loadBookCount();
  }
});

async function loadBookCount(){
  const snap = await db.collection("wordbooks")
    .where("owner","==",currentUser.uid)
    .get();
  document.getElementById("bookCount").textContent = snap.size;
}

async function updateUsername(){
  const newName = document.getElementById("usernameInput").value.trim();
  const msg = document.getElementById("nameMsg");

  if(!newName){
    msg.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  try{
    await currentUser.updateProfile({
      displayName: newName
    });

    // Firestoreã«ã‚‚ä¿å­˜ï¼ˆå˜èªå¸³è¡¨ç¤ºç”¨ï¼‰
    await db.collection("users").doc(currentUser.uid).set({
      username: newName
    });

    document.getElementById("usernameText").textContent = newName;
    msg.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å¤‰æ›´ã—ã¾ã—ãŸ";
    msg.className="success";
    document.getElementById("usernameInput").value="";
  }catch(e){
    msg.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
    msg.className="notice";
  }
}

async function changePassword(){
  const current=document.getElementById("currentPass").value;
  const newPass=document.getElementById("newPass").value;
  const msg=document.getElementById("passMsg");

  if(!current || !newPass){
    msg.textContent="ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  try{
    const cred = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      current
    );

    await currentUser.reauthenticateWithCredential(cred);
    await currentUser.updatePassword(newPass);

    msg.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ";
    msg.className="success";
    document.getElementById("currentPass").value="";
    document.getElementById("newPass").value="";
  }catch(e){
    msg.textContent="ã‚¨ãƒ©ãƒ¼: "+e.message;
    msg.className="notice";
  }
}
</script>

</body>
</html>
