<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, user-scalable=yes">
<title>マイページ</title>
<link rel="apple-touch-icon" sizes="1024x1024" href="./icon.png">
<link rel="icon" type="image/x-icon" href="./favicon.ico">
<link rel="stylesheet" type="text/css" href="style.css">
<style>
body{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.card{
  background:white;
  padding:25px;
  border-radius:12px;
  margin-bottom:20px;
}
input{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  width:100%;
  margin-top:8px;
}
.notice{
  color:red;
}
.success{
  color:green;
}
</style>
</head>
<body>

<header>
  <div class="headertitle"><a href="index.html"><img src="./headerrogo.png" height="45px"></a></div>
</header>

<main>

<div class="card">
  <h2>ユーザー情報</h2>
  <p>UID: <span id="uid"></span></p>
  <p>Email: <span id="email"></span></p>
  <p>ユーザー名: <span id="usernameText">未設定</span></p>
  <p>作成した単語帳数: <span id="bookCount">0</span></p>
</div>

<div class="card">
  <h2>ユーザー名設定・変更</h2>
  <input id="usernameInput" placeholder="新しいユーザー名">
  <button onclick="updateUsername()">変更する</button>
  <div id="nameMsg" class="notice"></div>
</div>

<div class="card">
  <h2>パスワード変更</h2>
  <input type="password" id="currentPass" placeholder="現在のパスワード">
  <input type="password" id="newPass" placeholder="新しいパスワード">
  <button onclick="changePassword()">変更する</button>
  <div id="passMsg" class="notice"></div>
</div>

</main>

<footer>
  <div class="footer-inner">
    <div>Vocaboost</div>
    <div class="footer-links">
      <a href="index.html">ホーム</a>
      <a href="list.html">公開単語帳</a>
      <a href="create.html">作成</a>
      <a href="mypage.html">マイページ</a>
      <a href="update.html">更新履歴</a>
    </div>
    <div class="copy">© 2026 Wordbook App</div>
  </div>
</footer>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7CJmO3eAO0o2EPRDsVqTtZ_whRd_3-3E",
  authDomain: "quiz1-4ffdc.firebaseapp.com",
  projectId: "quiz1-4ffdc"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;

auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="login.html";
  }else{
    currentUser = user;
    document.getElementById("uid").textContent = user.uid;
    document.getElementById("email").textContent = user.email;
    document.getElementById("usernameText").textContent = user.displayName || "未設定";

    loadBookCount();
  }
});

async function loadBookCount(){
  const snap = await db.collection("wordbooks")
    .where("owner","==",currentUser.uid)
    .get();
  document.getElementById("bookCount").textContent = snap.size;
}

async function updateUsername(){
  const newName = document.getElementById("usernameInput").value.trim();
  const msg = document.getElementById("nameMsg");

  if(!newName){
    msg.textContent = "ユーザー名を入力してください";
    return;
  }

  try{
    await currentUser.updateProfile({
      displayName: newName
    });

    // Firestoreにも保存（単語帳表示用）
    await db.collection("users").doc(currentUser.uid).set({
      username: newName
    });

    document.getElementById("usernameText").textContent = newName;
    msg.textContent = "ユーザー名を変更しました";
    msg.className="success";
    document.getElementById("usernameInput").value="";
  }catch(e){
    msg.textContent = "エラー: " + e.message;
    msg.className="notice";
  }
}

async function changePassword(){
  const current=document.getElementById("currentPass").value;
  const newPass=document.getElementById("newPass").value;
  const msg=document.getElementById("passMsg");

  if(!current || !newPass){
    msg.textContent="すべて入力してください";
    return;
  }

  try{
    const cred = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      current
    );

    await currentUser.reauthenticateWithCredential(cred);
    await currentUser.updatePassword(newPass);

    msg.textContent="パスワードを変更しました";
    msg.className="success";
    document.getElementById("currentPass").value="";
    document.getElementById("newPass").value="";
  }catch(e){
    msg.textContent="エラー: "+e.message;
    msg.className="notice";
  }
}
</script>

</body>
</html>
