<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>単語帳作成</title>

<link rel="stylesheet" href="style.css">

<style>
body{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

.card{
  background:white;
  padding:25px;
  border-radius:12px;
  margin-bottom:20px;
}

input{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}

.wordRow{
  display:flex;
  gap:10px;
  margin-top:15px;
}

.wordRow input{
  width:200px;
}

.wordItem{
  border-bottom:1px solid #ddd;
  padding:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.smallBtn{
  background:#ff5c5c;
  color:white;
  border:none;
  border-radius:6px;
  padding:4px 8px;
  cursor:pointer;
}

.notice{
  color:red;
}
</style>
</head>
<body>

<main>

<div class="card">
  <h2>単語帳情報</h2>
  <input id="title" placeholder="単語帳タイトル"><br><br>

  <label>
    <input type="checkbox" id="isPublic" checked>
    公開する
  </label><br><br>

  <button onclick="createBook()">単語帳を作成</button>
  <div id="msg" class="notice"></div>
</div>

<div class="card" id="wordArea" style="display:none">
  <h2>単語を追加（Enter対応）</h2>

  <div class="wordRow">
    <input id="front" placeholder="例：犬">
    <input id="back" placeholder="例：dog">
  </div>

  <div id="wordList"></div>

  <br>
  <button onclick="goView()">完成して見る</button>
</div>

</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7CJmO3eAO0o2EPRDsVqTtZ_whRd_3-3E",
  authDomain: "quiz1-4ffdc.firebaseapp.com",
  projectId: "quiz1-4ffdc",
  storageBucket: "quiz1-4ffdc.firebasestorage.app",
  messagingSenderId: "152062126332",
  appId: "1:152062126332:web:845af237a1a76207214f79"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let bookId = null;

/* ===== ログイン確認（安定版） ===== */
auth.onAuthStateChanged(user=>{
  if(!user){
    alert("ログインしてください");
    location.href="login.html";
    return;
  }
  currentUser = user;
});

/* ===== 単語帳作成 ===== */
async function createBook(){

  if(!currentUser){
    alert("ログイン情報確認中です。少し待ってください。");
    return;
  }

  const title = document.getElementById("title").value.trim();
  const isPublic = document.getElementById("isPublic").checked;
  const msg = document.getElementById("msg");

  if(!title){
    msg.textContent="タイトルを入力してください";
    return;
  }

  const doc = await db.collection("wordbooks").add({
    title:title,
    isPublic:isPublic,
    owner:currentUser.uid,
    ownerName:currentUser.displayName || "名無し",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  bookId = doc.id;

  document.getElementById("wordArea").style.display="block";
  msg.textContent="単語帳を作成しました。単語を追加してください";
}

/* ===== Enter操作 ===== */
document.addEventListener("DOMContentLoaded",()=>{

  const front=document.getElementById("front");
  const back=document.getElementById("back");

  front.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      back.focus();
    }
  });

  back.addEventListener("keydown",async e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      await addWord();
      front.focus();
    }
  });

});

/* ===== 単語追加 ===== */
async function addWord(){

  if(!bookId) return;

  const front=document.getElementById("front");
  const back=document.getElementById("back");

  const f=front.value.trim();
  const b=back.value.trim();

  if(!f || !b) return;

  const doc = await db.collection("wordbooks")
    .doc(bookId)
    .collection("words")
    .add({
      front:f,
      back:b,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  addWordToList(doc.id,f,b);

  front.value="";
  back.value="";
}

/* ===== 画面に追加 ===== */
function addWordToList(id,f,b){

  const div=document.createElement("div");
  div.className="wordItem";
  div.id="word_"+id;

  div.innerHTML = `
    <span>${f} → ${b}</span>
    <button class="smallBtn" onclick="deleteWord('${id}')">削除</button>
  `;

  document.getElementById("wordList").appendChild(div);
}

/* ===== 単語削除（修正版） ===== */
async function deleteWord(id){

  if(!confirm("削除しますか？")) return;

  await db.collection("wordbooks")
    .doc(bookId)
    .collection("words")
    .doc(id)
    .delete();

  const el = document.getElementById("word_"+id);
  if(el) el.remove();
}

/* ===== 閲覧ページへ ===== */
function goView(){
  if(!bookId) return;
  location.href="view.html?id="+bookId;
}
</script>

</body>
</html>
