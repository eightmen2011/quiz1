<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>単語帳編集</title>

<link rel="stylesheet" href="style.css">

<style>
.card{
  background:white;
  padding:25px;
  border-radius:12px;
  margin-bottom:20px;
}

.wordItem{
  border-bottom:1px solid #ddd;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.danger{
  background:#ff5c5c;
  color:white;
  border:none;
  padding:5px 10px;
  border-radius:8px;
  cursor:pointer;
}

.wordRow{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.wordRow input{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  width:200px;
}
</style>
</head>
<body>

<h2 id="title">読み込み中...</h2>

<div class="card">
  <button class="danger" onclick="deleteBook()">この単語帳を削除</button>
</div>

<div class="card">
  <h3>単語を追加</h3>
  <div id="inputArea"></div>
</div>

<div class="card">
  <h3>単語一覧</h3>
  <div id="wordList"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7CJmO3eAO0o2EPRDsVqTtZ_whRd_3-3E",
  authDomain: "quiz1-4ffdc.firebaseapp.com",
  projectId: "quiz1-4ffdc",
  storageBucket: "quiz1-4ffdc.firebasestorage.app",
  messagingSenderId: "152062126332",
  appId: "1:152062126332:web:845af237a1a76207214f79"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const params = new URLSearchParams(location.search);
const bookId = params.get("id");

if(!bookId){
  alert("URLにidがありません");
  throw new Error("bookId missing");
}

let currentUser = null;
let bookOwner = null;

/* ===== ログイン確認 ===== */
auth.onAuthStateChanged(user=>{
  if(!user){
    alert("ログインしてください");
    location.href="login.html";
    return;
  }
  currentUser = user;
  loadBook();
});

/* ===== 単語帳読み込み ===== */
async function loadBook(){
  const doc = await db.collection("wordbooks").doc(bookId).get();

  if(!doc.exists){
    alert("単語帳が見つかりません");
    return;
  }

  const data = doc.data();
  bookOwner = data.owner;

  if(currentUser.uid !== bookOwner){
    alert("編集権限がありません");
    location.href="view.html?id="+bookId;
    return;
  }

  document.getElementById("title").textContent = data.title;

  createInputRow();
  loadWords();
}

/* ===== 入力欄生成（常に1行） ===== */
function createInputRow(){
  const area = document.getElementById("inputArea");
  area.innerHTML = "";

  const row = document.createElement("div");
  row.className = "wordRow";

  const frontInput = document.createElement("input");
  frontInput.placeholder = "例：犬";

  const backInput = document.createElement("input");
  backInput.placeholder = "例：dog";

  // 左Enter → 右へ
  frontInput.addEventListener("keydown", e=>{
    if(e.key === "Enter"){
      e.preventDefault();
      backInput.focus();
    }
  });

  // 右Enter → 保存
  backInput.addEventListener("keydown", async e=>{
    if(e.key === "Enter"){
      e.preventDefault();

      const f = frontInput.value.trim();
      const b = backInput.value.trim();
      if(!f || !b) return;

      try{
        await db.collection("wordbooks")
          .doc(bookId)
          .collection("words")
          .add({ front:f, back:b });

        loadWords();
        createInputRow(); // 再生成
      }catch(err){
        console.error(err);
        alert("保存エラー");
      }
    }
  });

  row.appendChild(frontInput);
  row.appendChild(backInput);
  area.appendChild(row);

  frontInput.focus();
}

/* ===== 単語一覧 ===== */
async function loadWords(){
  const snap = await db.collection("wordbooks")
    .doc(bookId)
    .collection("words")
    .get();

  const area = document.getElementById("wordList");
  area.innerHTML = "";

  snap.forEach(doc=>{
    const w = doc.data();

    const div = document.createElement("div");
    div.className = "wordItem";
    div.id = "word_" + doc.id;

    div.innerHTML = `
      ${w.front} → ${w.back}
      <button class="danger" onclick="deleteWord('${doc.id}')">削除</button>
    `;

    area.appendChild(div);
  });
}

/* ===== 単語削除 ===== */
async function deleteWord(id){
  if(!confirm("削除しますか？")) return;

  await db.collection("wordbooks")
    .doc(bookId)
    .collection("words")
    .doc(id)
    .delete();

  loadWords();
}

/* ===== 単語帳削除 ===== */
async function deleteBook(){
  if(!confirm("本当に削除しますか？")) return;

  await db.collection("wordbooks").doc(bookId).delete();
  alert("削除しました");
  location.href="index.html";
}
</script>

</body>
</html>
